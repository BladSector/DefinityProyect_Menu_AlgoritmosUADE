{% extends "base.html" %}

{% block title %}Vista Mozos - Sistema de Restaurante{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h4>Interfaz Mozos</h4>
            </div>
            <div class="card-body">
                <div class="list-group">
                    <button class="list-group-item list-group-item-action" onclick="verMapaRestaurante()">
                        1. Mapa del Restaurante
                    </button>
                    <button class="list-group-item list-group-item-action" onclick="reiniciarMesa()">
                        2. Reiniciar mesa
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="row">
            <!-- Secci√≥n de Pagos Pendientes -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header bg-warning">
                        <h4>Pagos Pendientes</h4>
                    </div>
                    <div class="card-body" id="pagosPendientesContainer">
                        <!-- El contenido se actualizar√° autom√°ticamente -->
                    </div>
                </div>
            </div>

            <!-- Secci√≥n de Pedidos Listos -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h4>Pedidos Listos para Entregar</h4>
                    </div>
                    <div class="card-body" id="pedidosListosContainer">
                        <!-- El contenido se actualizar√° autom√°ticamente -->
                    </div>
                </div>
            </div>

            <!-- Secci√≥n de Comentarios Pendientes -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4>Comentarios Pendientes</h4>
                    </div>
                    <div class="card-body" id="comentariosContainer">
                        <!-- El contenido se actualizar√° autom√°ticamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para gestionar pedido -->
<div class="modal fade" id="gestionarPedidoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gestionar Pedido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="detallesPedido"></div>
                <div id="opcionesPedido" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para reiniciar mesa -->
<div class="modal fade" id="reiniciarMesaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reiniciar Mesa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- El contenido se actualizar√° autom√°ticamente -->
                </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let gestionarPedidoModal = null;
let reiniciarMesaModal = null;

document.addEventListener('DOMContentLoaded', function() {
    gestionarPedidoModal = new bootstrap.Modal(document.getElementById('gestionarPedidoModal'));
    reiniciarMesaModal = new bootstrap.Modal(document.getElementById('reiniciarMesaModal'));
    
    // Cargar contenido inicial
    actualizarPedidosListos();
    actualizarComentarios();
    actualizarPagosPendientes();
    
    // Actualizaci√≥n autom√°tica cada 3 segundos
    setInterval(() => {
        actualizarPedidosListos();
        actualizarComentarios();
        actualizarPagosPendientes();
    }, 3000);
});

function actualizarPedidosListos() {
    fetch('/api/mozos/pedidos-listos')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('pedidosListosContainer');
            
            // Limpiar el contenedor completamente
            container.innerHTML = '';
            
            if (!data.pedidos || data.pedidos.length === 0) {
                container.innerHTML = `
                            <div class="alert alert-info">
                                <h4 class="alert-heading">‚ÑπÔ∏è No hay pedidos listos para entregar</h4>
                                <p>Los pedidos aparecer√°n aqu√≠ cuando la cocina los marque como listos.</p>
                    </div>
                `;
                return;
            }

            // Construir el nuevo contenido
            const nuevoContenido = document.createElement('div');
            nuevoContenido.innerHTML = `
                        <div class="list-group">
                            ${data.pedidos.map(pedido => `
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1">${pedido.cantidad || 1}x ${pedido.nombre}</h6>
                                            <p class="mb-1">${pedido.mesa_nombre}</p>
                                            <p class="mb-1">üë§ ${pedido.cliente}</p>
                                            <p class="mb-1">
                                                <span class="badge bg-success">‚úÖ LISTO PARA ENTREGAR</span>
                                                ${pedido.hora_envio ? `<span class="text-muted">[Enviado: ${pedido.hora_envio} hs]</span>` : ''}
                                            </p>
                                            ${pedido.notas && pedido.notas.length > 0 ? `
                                                <small class="text-muted">
                                                    üìù Notas:<br>
                                                    ${pedido.notas.map(nota => `‚Ä¢ ${nota.texto}`).join('<br>')}
                                                </small>
                                            ` : ''}
                                        </div>
                                        <button class="btn btn-success" onclick="mostrarConfirmacionEntrega('${pedido.mesa_id}', '${pedido.cliente}', '${pedido.id}', '${pedido.nombre}', '${pedido.mesa_nombre}')">
                                            Marcar como Entregado
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
            `;

            // Agregar el nuevo contenido
            container.appendChild(nuevoContenido.firstElementChild);
        })
        .catch(error => {
            console.error('Error:', error);
            const container = document.getElementById('pedidosListosContainer');
            const alertaError = document.createElement('div');
            alertaError.className = 'alert alert-danger';
            alertaError.textContent = `Error al cargar los pedidos listos: ${error.message}`;
            container.insertBefore(alertaError, container.firstChild);
            
            // Auto-cerrar la alerta de error despu√©s de 5 segundos
            setTimeout(() => {
                alertaError.classList.remove('show');
                setTimeout(() => alertaError.remove(), 150);
            }, 5000);
        });
}

function actualizarComentarios() {
    fetch('/api/mozos/comentarios-pendientes')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('comentariosContainer');
            if (data.comentarios.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <h4 class="alert-heading">No hay comentarios pendientes</h4>
                        <p>En este momento no hay comentarios pendientes de resolver.</p>
                    </div>
                `;
                return;
            }
            container.innerHTML = `
                <div class="list-group">
                    ${data.comentarios.map((comentario, index) => `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-1">${comentario.mesa_nombre}</h5>
                                    <p class="mb-1">üë§ ${comentario.cliente}</p>
                                    <p class="mb-1">üìù ${comentario.texto}</p>
                                    <small class="text-muted">[Enviado: ${comentario.hora}]</small>
                                </div>
                                <button class="btn btn-success" onclick="marcarComentarioRealizado('${comentario.mesa_id}', '${comentario.cliente}', '${comentario.texto}')">
                                    Marcar como Realizado
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('comentariosContainer').innerHTML = `
                <div class="alert alert-danger">
                    Error al cargar los comentarios: ${error.message}
                </div>
            `;
        });
}

function verMapaRestaurante() {
    fetch('/api/mozos/mapa-mesas')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Eliminar modal existente si hay uno
                const modalExistente = document.getElementById('mapaRestauranteModal');
                if (modalExistente) {
                    modalExistente.remove();
                }

                // Crear el modal
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'mapaRestauranteModal';
                modal.setAttribute('tabindex', '-1');
                modal.setAttribute('aria-labelledby', 'mapaRestauranteModalLabel');
                modal.setAttribute('aria-hidden', 'true');

                // Crear el contenido del modal
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="mapaRestauranteModalLabel">Mapa del Restaurante</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row row-cols-1 row-cols-md-3 g-4">
                                    ${data.data.map(mesa => `
                                        <div class="col">
                                            <div class="card h-100 ${mesa.estado === 'ocupada' ? 'border-danger' : 'border-success'}">
                                                <div class="card-body">
                                                    <h5 class="card-title">Mesa ${mesa.nombre}</h5>
                                                    <p class="card-text">
                                                        <span class="badge ${mesa.estado === 'ocupada' ? 'bg-danger' : 'bg-success'}">
                                                            ${mesa.estado === 'ocupada' ? 'Ocupada' : 'Libre'}
                                                        </span>
                                                    </p>
                                                    <button class="btn btn-primary btn-sm" onclick="verDetallesMesa('${mesa.id}')">
                                                        Ver Detalles
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                `;

                // Agregar el modal al body
                document.body.appendChild(modal);

                // Inicializar el modal
                const modalInstance = new bootstrap.Modal(modal);
                modalInstance.show();

                // Limpiar el modal cuando se cierre
                modal.addEventListener('hidden.bs.modal', function () {
                    modal.remove();
                });
            } else {
                alert('Error al cargar el mapa del restaurante');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar el mapa del restaurante');
        });
}

function verDetallesMesa(mesaId) {
    fetch(`/api/mozos/mesas/${mesaId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Eliminar modal existente si hay uno
                const modalExistente = document.getElementById('detallesMesaModal');
                if (modalExistente) {
                    modalExistente.remove();
                }

                // Crear el modal
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'detallesMesaModal';
                modal.setAttribute('tabindex', '-1');
                modal.setAttribute('aria-labelledby', 'detallesMesaModalLabel');
                modal.setAttribute('aria-hidden', 'true');

                // Crear el contenido del modal
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="detallesMesaModalLabel">Detalles ${data.data.nombre}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="accordion" id="accordionDetalles">
                                    <!-- Pedidos en Cocina -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCocina">
                                                Pedidos en Cocina (${data.data.pedidos_en_cocina.length})
                                            </button>
                                        </h2>
                                        <div id="collapseCocina" class="accordion-collapse collapse show" data-bs-parent="#accordionDetalles">
                                            <div class="accordion-body">
                                                ${data.data.pedidos_en_cocina.length > 0 ? 
                                                    data.data.pedidos_en_cocina.map(pedido => `
                                                        <div class="card mb-2">
                                                            <div class="card-body">
                                                                <h6 class="card-title">${pedido.nombre} (${pedido.cliente})</h6>
                                                                <p class="card-text">
                                                                    Cantidad: ${pedido.cantidad}<br>
                                                                    Estado: ${pedido.estado_cocina}<br>
                                                                    Hora: ${pedido.hora_envio}
                                                                </p>
                                                                ${pedido.notas && pedido.notas.length > 0 ? `
                                                                    <div class="alert alert-info">
                                                                        <small>Notas: ${pedido.notas.map(n => n.texto).join(', ')}</small>
                                                                    </div>
                                                                ` : ''}
                                                            </div>
                                                        </div>
                                                    `).join('') : 
                                                    '<p class="text-muted">No hay pedidos en cocina</p>'
                                                }
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Pedidos Entregados -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEntregados">
                                                Pedidos Entregados (${data.data.pedidos_entregados.length})
                                            </button>
                                        </h2>
                                        <div id="collapseEntregados" class="accordion-collapse collapse" data-bs-parent="#accordionDetalles">
                                            <div class="accordion-body">
                                                ${data.data.pedidos_entregados.length > 0 ? 
                                                    data.data.pedidos_entregados.map(pedido => `
                                                        <div class="card mb-2">
                                                            <div class="card-body">
                                                                <h6 class="card-title">${pedido.nombre} (${pedido.cliente})</h6>
                                                                <p class="card-text">
                                                                    Cantidad: ${pedido.cantidad}<br>
                                                                    Estado: ${pedido.estado_cocina}<br>
                                                                    Hora: ${pedido.hora_envio}
                                                                </p>
                                                                ${pedido.notas && pedido.notas.length > 0 ? `
                                                                    <div class="alert alert-info">
                                                                        <small>Notas: ${pedido.notas.map(n => n.texto).join(', ')}</small>
                                                                    </div>
                                                                ` : ''}
                                                            </div>
                                                        </div>
                                                    `).join('') : 
                                                    '<p class="text-muted">No hay pedidos entregados</p>'
                                                }
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Solicitudes al Camarero -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolicitudes">
                                                Solicitudes al Camarero (${data.data.comentarios_camarero ? data.data.comentarios_camarero.length : 0})
                                            </button>
                                        </h2>
                                        <div id="collapseSolicitudes" class="accordion-collapse collapse" data-bs-parent="#accordionDetalles">
                                            <div class="accordion-body">
                                                ${data.data.comentarios_camarero && data.data.comentarios_camarero.length > 0 ? 
                                                    data.data.comentarios_camarero.map(solicitud => `
                                                        <div class="card mb-2">
                                                            <div class="card-body">
                                                                <h6 class="card-title">${solicitud.cliente}</h6>
                                                                <p class="card-text">
                                                                    ${solicitud.mensaje}<br>
                                                                    <small class="text-muted">Hora: ${solicitud.hora}</small>
                                                                </p>
                                                                ${!solicitud.resuelto ? `
                                                                    <button class="btn btn-success btn-sm" onclick="marcarSolicitudResuelta('${mesaId}', '${solicitud.cliente}', '${solicitud.mensaje}')">
                                                                        Marcar como Resuelto
                                                                    </button>
                                                                ` : `
                                                                    <span class="badge bg-success">Resuelto</span>
                                                                `}
                                                            </div>
                                                        </div>
                                                    `).join('') : 
                                                    '<p class="text-muted">No hay solicitudes pendientes</p>'
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                `;

                // Agregar el modal al body
                document.body.appendChild(modal);

                // Inicializar el modal
                const modalInstance = new bootstrap.Modal(modal);
                modalInstance.show();

                // Limpiar el modal cuando se cierre
                modal.addEventListener('hidden.bs.modal', function () {
                    modal.remove();
                });
            } else {
                alert('Error al cargar los detalles de la mesa');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar los detalles de la mesa');
        });
}

function mostrarConfirmacionEntrega(mesaId, cliente, pedidoId, nombrePedido, nombreMesa) {
    // Verificar si ya existe un modal abierto
    const modalExistente = document.getElementById('confirmacionEntregaModal');
    if (modalExistente) {
        const modal = bootstrap.Modal.getInstance(modalExistente);
        if (modal) {
            modal.hide();
        }
        modalExistente.remove();
    }

    const modalHtml = `
        <div class="modal fade" id="confirmacionEntregaModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirmar Entrega</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <p><strong>Pedido:</strong> ${nombrePedido}</p>
                            <p><strong>Mesa:</strong> ${nombreMesa}</p>
                            <p><strong>Cliente:</strong> ${cliente}</p>
                        </div>
                        <p>¬øEst√° seguro que desea marcar este pedido como entregado?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-success" onclick="confirmarEntrega('${mesaId}', '${cliente}', '${pedidoId}')">Confirmar Entrega</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Agregar el modal al body
        document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('confirmacionEntregaModal'));
    modal.show();

    // Limpiar el modal cuando se cierre
    document.getElementById('confirmacionEntregaModal').addEventListener('hidden.bs.modal', function () {
        this.remove();
    });
}

function confirmarEntrega(mesaId, cliente, pedidoId) {
    fetch(`/api/mozos/pedidos/${pedidoId}/entregar`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            mesa_id: mesaId,
            cliente: cliente
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Cerrar el modal de confirmaci√≥n
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmacionEntregaModal'));
            modal.hide();
            
            // Mostrar mensaje de √©xito
            const container = document.getElementById('pedidosListosContainer');
            const alerta = document.createElement('div');
            alerta.className = 'alert alert-success alert-dismissible fade show';
            alerta.innerHTML = `
                <strong>‚úÖ Pedido entregado exitosamente</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            container.insertBefore(alerta, container.firstChild);
            
            // Auto-cerrar la alerta despu√©s de 3 segundos
            setTimeout(() => {
                alerta.classList.remove('show');
                setTimeout(() => alerta.remove(), 150);
            }, 3000);
            
            // Solo actualizar la lista de pedidos
            setTimeout(() => {
                actualizarPedidosListos();
            }, 500);
        } else {
            mostrarMensaje(data.error || 'Error al marcar el pedido como entregado', 'danger');
        }
    })
    .catch(error => {
        mostrarMensaje('Error al marcar el pedido como entregado: ' + error.message, 'danger');
    });
}

function marcarComentarioRealizado(mesaId, cliente, texto) {
    // Verificar si ya existe un modal abierto
    const modalExistente = document.getElementById('confirmacionComentarioModal');
    if (modalExistente) {
        const modal = bootstrap.Modal.getInstance(modalExistente);
        if (modal) {
            modal.hide();
        }
        modalExistente.remove();
    }

    const modalHtml = `
        <div class="modal fade" id="confirmacionComentarioModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirmar Acci√≥n</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <p><strong>Cliente:</strong> ${cliente}</p>
                            <p><strong>Comentario:</strong> ${texto}</p>
                        </div>
                        <p>¬øEst√° seguro que desea marcar este comentario como realizado?</p>
                </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-success" onclick="confirmarMarcarComentario('${mesaId}', '${cliente}', '${texto}')">
                        S√≠, marcar como realizado
                    </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Agregar el modal al body
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('confirmacionComentarioModal'));
    modal.show();

    // Limpiar el modal cuando se cierre
    document.getElementById('confirmacionComentarioModal').addEventListener('hidden.bs.modal', function () {
        this.remove();
    });
}

function confirmarMarcarComentario(mesaId, cliente, texto) {
    fetch(`/api/mozos/comentarios/${mesaId}/realizar`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            cliente: cliente,
            texto: texto
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Cerrar el modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmacionComentarioModal'));
            modal.hide();
            
            // Mostrar mensaje de √©xito en la secci√≥n de comentarios
            const container = document.getElementById('comentariosContainer');
            const alerta = document.createElement('div');
            alerta.className = 'alert alert-success alert-dismissible fade show';
            alerta.innerHTML = `
                <strong>‚úÖ Comentario marcado como realizado exitosamente</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            container.insertBefore(alerta, container.firstChild);
            
            // Auto-cerrar la alerta despu√©s de 3 segundos
            setTimeout(() => {
                alerta.classList.remove('show');
                setTimeout(() => alerta.remove(), 150);
            }, 3000);
            
            // Actualizar la lista de comentarios inmediatamente
            setTimeout(() => actualizarComentarios(), 500);
        } else {
            mostrarMensaje(data.error || 'Error al marcar el comentario como realizado', 'danger');
        }
    })
    .catch(error => {
        mostrarMensaje('Error al marcar el comentario como realizado: ' + error.message, 'danger');
    });
}

function mostrarMensaje(mensaje, tipo) {
    const contenido = document.getElementById('contenidoDinamico');
    const alerta = document.createElement('div');
    alerta.className = `alert alert-${tipo} alert-dismissible fade show`;
    alerta.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    contenido.insertBefore(alerta, contenido.firstChild);
    
    // Auto-cerrar la alerta despu√©s de 5 segundos
    setTimeout(() => {
        alerta.classList.remove('show');
        setTimeout(() => alerta.remove(), 150);
    }, 5000);
}

function marcarSolicitudResuelta(mesaId, cliente) {
    if (confirm('¬øEst√° seguro que desea marcar esta solicitud como resuelta?')) {
        fetch(`/api/mozos/solicitudes/${mesaId}/resuelta`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                cliente: cliente
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const contenido = document.getElementById('contenidoDinamico');
                contenido.innerHTML = `
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h4>‚úÖ Solicitud Marcada como Resuelta</h4>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-success">
                                <h5>La solicitud ha sido marcada como resuelta exitosamente</h5>
                                <hr>
                                <p><strong>Cliente:</strong> ${cliente}</p>
                                <p><strong>Hora de resoluci√≥n:</strong> ${new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'})}</p>
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-primary" onclick="verDetallesMesa('${mesaId}')">
                                    Volver a los detalles de la mesa
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                mostrarMensaje('Error: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            mostrarMensaje('Error al procesar la solicitud: ' + error.message, 'danger');
        });
    }
}

function reiniciarMesa() {
    fetch('/api/mozos/mesas-ocupadas')
        .then(response => response.json())
        .then(data => {
            // Verificar si ya existe un modal abierto
            const modalExistente = document.getElementById('reiniciarMesaModal');
            if (modalExistente) {
                const modal = bootstrap.Modal.getInstance(modalExistente);
                if (modal) {
                    modal.hide();
                }
                modalExistente.remove();
            }

            const modalHtml = `
                <div class="modal fade" id="reiniciarMesaModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Reiniciar Mesa</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${data.mesas.length === 0 ? `
                    <div class="alert alert-info">
                        <h4 class="alert-heading">No hay mesas ocupadas</h4>
                        <p>En este momento no hay mesas que puedan ser reiniciadas.</p>
                    </div>
                                ` : `
                <div class="list-group">
                    ${data.mesas.map((mesa, index) => `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-1">${mesa.nombre}</h5>
                                    <p class="mb-1">Estado: ${mesa.estado === 'libre' ? 'üü¢ Libre' : 'üü† Ocupada'}</p>
                                </div>
                                <button class="btn btn-danger" onclick="confirmarReinicioMesa('${mesa.id}')">
                                    Reiniciar Mesa
                                </button>
                            </div>
                        </div>
                    `).join('')}
                                    </div>
                                `}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Agregar el modal al body
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('reiniciarMesaModal'));
            modal.show();

            // Limpiar el modal cuando se cierre
            document.getElementById('reiniciarMesaModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarMensaje('Error al cargar las mesas: ' + error.message, 'danger');
        });
}

function confirmarReinicioMesa(mesaId) {
    // Verificar si ya existe un modal abierto
    const modalExistente = document.getElementById('confirmacionReinicioModal');
    if (modalExistente) {
        const modal = bootstrap.Modal.getInstance(modalExistente);
        if (modal) {
            modal.hide();
        }
        modalExistente.remove();
    }

    const modalHtml = `
        <div class="modal fade" id="confirmacionReinicioModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirmar Reinicio</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <h4 class="alert-heading">‚ö†Ô∏è Advertencia</h4>
                            <p>Esta acci√≥n reiniciar√° completamente la mesa, eliminando todos los pedidos y comentarios.</p>
                            <p>¬øEst√° seguro que desea continuar?</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-danger" onclick="ejecutarReinicioMesa('${mesaId}')">
                            S√≠, reiniciar mesa
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Agregar el modal al body
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('confirmacionReinicioModal'));
    modal.show();

    // Limpiar el modal cuando se cierre
    document.getElementById('confirmacionReinicioModal').addEventListener('hidden.bs.modal', function () {
        this.remove();
    });
}

function ejecutarReinicioMesa(mesaId) {
    // Cerrar el modal de confirmaci√≥n
    const modalConfirmacion = bootstrap.Modal.getInstance(document.getElementById('confirmacionReinicioModal'));
    modalConfirmacion.hide();

        fetch(`/api/mozos/mesas/${mesaId}/reiniciar`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
            // Cerrar el modal de reinicio
            const modalReinicio = bootstrap.Modal.getInstance(document.getElementById('reiniciarMesaModal'));
            modalReinicio.hide();
            
            // Mostrar mensaje de √©xito
            const container = document.getElementById('pedidosListosContainer');
            const alerta = document.createElement('div');
            alerta.className = 'alert alert-success alert-dismissible fade show';
            alerta.innerHTML = `
                <strong>‚úÖ Mesa reiniciada exitosamente</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            container.insertBefore(alerta, container.firstChild);
            
            // Auto-cerrar la alerta despu√©s de 3 segundos
            setTimeout(() => {
                alerta.classList.remove('show');
                setTimeout(() => alerta.remove(), 150);
            }, 3000);
            
            // Actualizar las listas
            setTimeout(() => {
                actualizarPedidosListos();
                actualizarComentarios();
            }, 500);
            } else {
            mostrarMensaje('Error: ' + data.error, 'danger');
            }
    })
    .catch(error => {
        mostrarMensaje('Error al reiniciar la mesa: ' + error.message, 'danger');
        });
}

function getBadgeClass(estado) {
    switch (estado) {
        case '‚è≥ PENDIENTE':
            return 'bg-warning';
        case 'üë®‚Äçüç≥ EN PREPARACI√ìN':
            return 'bg-primary';
        case '‚úÖ LISTO PARA ENTREGAR':
            return 'bg-success';
        case 'üî¥ CANCELADO':
            return 'bg-danger';
        default:
            return 'bg-secondary';
    }
}

function actualizarPagosPendientes() {
    fetch('/api/mozos/pagos-pendientes')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('pagosPendientesContainer');
            
            if (!data.pagos || data.pagos.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <h4 class="alert-heading">No hay pagos pendientes</h4>
                        <p>Los pagos aparecer√°n aqu√≠ cuando los clientes soliciten pagar su cuenta.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="list-group">
                    ${data.pagos.map(pago => `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-1">Mesa ${pago.mesa_nombre}</h5>
                                    <p class="mb-1">
                                        <strong>Cliente:</strong> ${pago.cliente}<br>
                                        <strong>Tipo:</strong> ${pago.tipo_pago}<br>
                                        <strong>M√©todo:</strong> ${pago.metodo_pago}<br>
                                        <strong>Total:</strong> $${pago.total}
                                    </p>
                                    <small class="text-muted">Solicitado: ${pago.hora_solicitud}</small>
                                </div>
                                <div>
                                    <button class="btn btn-success" onclick="confirmarPago('${pago.mesa_id}', '${pago.cliente}', '${pago.tipo_pago}', '${pago.metodo_pago}', ${pago.total})">
                                        Confirmar Pago
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        })
        .catch(error => {
            console.error('Error:', error);
            const container = document.getElementById('pagosPendientesContainer');
            container.innerHTML = `
                <div class="alert alert-danger">
                    Error al cargar los pagos pendientes: ${error.message}
                </div>
            `;
        });
}

function confirmarPago(mesaId, cliente, tipoPago, metodoPago, total) {
    if (confirm(`¬øConfirmar pago de $${total} por ${cliente} (${tipoPago} - ${metodoPago})?`)) {
        fetch(`/api/mozos/pagos/${mesaId}/confirmar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                cliente: cliente,
                tipo_pago: tipoPago,
                metodo_pago: metodoPago,
                total: total
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mostrar mensaje de √©xito
                const container = document.getElementById('pagosPendientesContainer');
                const alerta = document.createElement('div');
                alerta.className = 'alert alert-success alert-dismissible fade show';
                alerta.innerHTML = `
                    <strong>‚úÖ Pago confirmado exitosamente</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                container.insertBefore(alerta, container.firstChild);
                
                // Auto-cerrar la alerta despu√©s de 3 segundos
                setTimeout(() => {
                    alerta.classList.remove('show');
                    setTimeout(() => alerta.remove(), 150);
                }, 3000);
                
                // Actualizar la lista de pagos
                setTimeout(() => actualizarPagosPendientes(), 500);
            } else {
                mostrarMensaje(data.error || 'Error al confirmar el pago', 'danger');
            }
        })
        .catch(error => {
            mostrarMensaje('Error al confirmar el pago: ' + error.message, 'danger');
        });
    }
}
</script>
{% endblock %} 